# container for cloudbuild, use with ci/cloudbuild/vizzu-devenv-docker.yaml

FROM ubuntu:focal


RUN apt-get update; \
    echo 'debconf debconf/frontend select Noninteractive' | debconf-set-selections && apt-get install -y -q; \
    apt-get install -y apt-utils dialog software-properties-common wget
RUN wget -O - https://vizzuhq.github.io/ppa/ubuntu/KEY.gpg | apt-key add -; \
    add-apt-repository "deb https://vizzuhq.github.io/ppa/ubuntu ./"; \
    apt-get install -y vizzu-devenv
 
RUN apt-get update; \
    apt-get -y install g++-10
RUN wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | apt-key add -; \
    add-apt-repository "deb http://apt.llvm.org/focal/ llvm-toolchain-focal-12 main"; \
    apt-get update; \
    apt-get -y install clang-12 clang-tools-12 lldb-12 lld-12 clang-tidy-12 clang-format-12; \
    update-alternatives --install /usr/bin/clang clang /usr/bin/clang-12 120; \
    update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-12 120; \
    update-alternatives --install /usr/bin/c++ c++ /usr/bin/clang++-12 120
    
COPY . /workspace

RUN mkdir -p /workspace/build/cmake-wasm
WORKDIR /workspace/build/cmake-wasm
RUN /root/emsdk/upstream/emscripten/emcmake cmake ../../project/cmake/
RUN make

WORKDIR /workspace/build/cmake-wasm/test
RUN node vizzutest.js

RUN mkdir -p /workspace/build/cmake-desktop
WORKDIR /workspace/build/cmake-desktop
RUN cmake ../../project/cmake/
RUN make

WORKDIR /workspace/build/cmake-desktop/test
RUN ./vizzutest

RUN wget --quiet -O - https://deb.nodesource.com/setup_14.x | bash; \
    apt-get -y install nodejs

RUN apt-get update; \
    apt-get install -y fonts-roboto gnupg wget curl unzip --no-install-recommends
    
RUN wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add - && \
    echo "deb http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list && \
    apt-get update -y && \
    apt-get install -y google-chrome-stable && \
    CHROMEVER=$(google-chrome --product-version | grep -o "[^\.]*\.[^\.]*\.[^\.]*") && \
    DRIVERVER=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROMEVER") && \
    wget -q --continue -P /chromedriver "http://chromedriver.storage.googleapis.com/$DRIVERVER/chromedriver_linux64.zip" && \
    unzip /chromedriver/chromedriver* -d /chromedriver

WORKDIR /workspace/test/integration
RUN npm install
RUN node vizzutest.js